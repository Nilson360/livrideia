{% extends 'home/desktop/base_desktop.html.twig' %}

{% block title %}Changer de mot de passe{% endblock %}

{% block content %}
    <div class="max-w-4xl mx-auto mt-8 mb-16 px-4">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden mb-6">
            <div class="p-6 border-b border-gray-100">
                <div class="flex items-center gap-4">
                    <div class="p-3 bg-gradient-to-br from-gray-600 to-gray-700 rounded-xl">
                        <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Changer de mot de passe</h1>
                        <p class="text-gray-500 text-sm">Renforcez la sécurité de votre compte</p>
                    </div>
                </div>
            </div>

            <!-- Navigation de retour -->
            <div class="px-6 py-3 bg-gray-50 border-b border-gray-100">
                <a href="{{ path('dashboard_user_profile') }}"
                   class="inline-flex items-center text-sm text-gray-600 hover:text-[#FF8A00] transition-colors">
                    <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Retour au profil
                </a>
            </div>
        </div>

        <!-- Formulaire -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-6">
                <!-- Conseils de sécurité -->
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg class="w-5 h-5 text-blue-600 mt-0.5" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-semibold text-blue-800">Conseils pour un mot de passe sécurisé</h3>
                            <ul class="mt-2 text-sm text-blue-700 space-y-1">
                                <li>• Au moins 8 caractères</li>
                                <li>• Mélangez majuscules, minuscules, chiffres et symboles</li>
                                <li>• Évitez les informations personnelles</li>
                                <li>• Utilisez un mot de passe unique pour Livridea</li>
                            </ul>
                        </div>
                    </div>
                </div>

                {{ form_start(form, {'attr': {'class': 'space-y-6'}}) }}

                <!-- Ancien mot de passe -->
                <div>
                    {{ form_label(form.oldPassword, 'Ancien mot de passe', {
                        'label_attr': {'class': 'block text-gray-700 font-semibold text-sm mb-2'}
                    }) }}
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>
                            </svg>
                        </div>
                        {{ form_widget(form.oldPassword, {
                            'attr': {
                                'class': 'w-full border border-gray-200 rounded-xl bg-gray-50 text-gray-700 pl-10 pr-12 py-3 text-sm focus:ring-2 focus:ring-gray-500 focus:border-gray-500 focus:bg-white transition-all duration-200',
                                'placeholder': 'Saisissez votre mot de passe actuel',
                                'id': 'old-password'
                            }
                        }) }}
                        <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center toggle-password" data-target="old-password">
                            <svg class="w-5 h-5 text-gray-400 hover:text-gray-600 cursor-pointer eye-open" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                            </svg>
                            <svg class="w-5 h-5 text-gray-400 hover:text-gray-600 cursor-pointer eye-closed hidden" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>
                            </svg>
                        </button>
                    </div>
                    {{ form_errors(form.oldPassword) }}
                </div>

                <!-- Nouveau mot de passe -->
                <div>
                    {{ form_label(form.newPassword, 'Nouveau mot de passe', {
                        'label_attr': {'class': 'block text-gray-700 font-semibold text-sm mb-2'}
                    }) }}
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                            </svg>
                        </div>
                        {{ form_widget(form.newPassword, {
                            'attr': {
                                'class': 'w-full border border-gray-200 rounded-xl bg-gray-50 text-gray-700 pl-10 pr-12 py-3 text-sm focus:ring-2 focus:ring-[#FF8A00] focus:border-[#FF8A00] focus:bg-white transition-all duration-200',
                                'placeholder': 'Créez un nouveau mot de passe sécurisé',
                                'id': 'new-password'
                            }
                        }) }}
                        <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center toggle-password" data-target="new-password">
                            <svg class="w-5 h-5 text-gray-400 hover:text-gray-600 cursor-pointer eye-open" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                            </svg>
                            <svg class="w-5 h-5 text-gray-400 hover:text-gray-600 cursor-pointer eye-closed hidden" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/>
                            </svg>
                        </button>
                    </div>

                    <!-- Indicateur de force du mot de passe -->
                    <div class="mt-2">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs text-gray-500">Force du mot de passe</span>
                            <span id="password-strength-text" class="text-xs text-gray-500">-</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="password-strength-bar" class="h-2 rounded-full transition-all duration-300 bg-gray-300" style="width: 0%"></div>
                        </div>
                    </div>

                    {{ form_errors(form.newPassword) }}
                </div>

                <!-- Boutons d'action -->
                <div class="border-t border-gray-100 pt-6 flex flex-col sm:flex-row gap-4 justify-between">
                    <a href="{{ path('dashboard_user_profile') }}"
                       class="inline-flex items-center justify-center px-6 py-3 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-xl transition-all duration-200 hover:scale-105">
                        <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Annuler
                    </a>

                    <button type="submit"
                            class="inline-flex items-center justify-center bg-gradient-to-r from-gray-600 to-gray-700 text-white px-8 py-3 rounded-xl shadow-md hover:shadow-lg text-sm font-semibold transition-all duration-200 hover:scale-105">
                        <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12.65 10C11.83 7.67 9.61 6 7 6c-3.31 0-6 2.69-6 6s2.69 6 6 6c2.61 0 4.83-1.67 5.65-4H17v4h4v-4h2v-4H12.65zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                        </svg>
                        Mettre à jour le mot de passe
                    </button>
                </div>

                {{ form_end(form) }}
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Gestion de l'affichage/masquage du mot de passe
            document.querySelectorAll('.toggle-password').forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    const passwordInput = document.getElementById(targetId);
                    const eyeOpen = this.querySelector('.eye-open');
                    const eyeClosed = this.querySelector('.eye-closed');

                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        eyeOpen.classList.add('hidden');
                        eyeClosed.classList.remove('hidden');
                    } else {
                        passwordInput.type = 'password';
                        eyeOpen.classList.remove('hidden');
                        eyeClosed.classList.add('hidden');
                    }
                });
            });

            // Vérification de la force du mot de passe
            const newPasswordInput = document.getElementById('new-password');
            const strengthBar = document.getElementById('password-strength-bar');
            const strengthText = document.getElementById('password-strength-text');

            if (newPasswordInput && strengthBar && strengthText) {
                newPasswordInput.addEventListener('input', function() {
                    const password = this.value;
                    const strength = calculatePasswordStrength(password);
                    updatePasswordStrengthDisplay(strength);
                });
            }

            function calculatePasswordStrength(password) {
                let score = 0;

                if (password.length >= 8) score += 1;
                if (password.length >= 12) score += 1;
                if (/[a-z]/.test(password)) score += 1;
                if (/[A-Z]/.test(password)) score += 1;
                if (/[0-9]/.test(password)) score += 1;
                if (/[^A-Za-z0-9]/.test(password)) score += 1;

                return Math.min(score, 4);
            }

            function updatePasswordStrengthDisplay(strength) {
                const colors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-emerald-500'];
                const texts = ['Très faible', 'Faible', 'Moyen', 'Fort'];
                const widths = ['25%', '50%', '75%', '100%'];

                // Reset classes
                strengthBar.className = 'h-2 rounded-full transition-all duration-300';

                if (strength > 0) {
                    strengthBar.classList.add(colors[strength - 1]);
                    strengthBar.style.width = widths[strength - 1];
                    strengthText.textContent = texts[strength - 1];
                    strengthText.className = `text-xs ${colors[strength - 1].replace('bg-', 'text-')}`;
                } else {
                    strengthBar.classList.add('bg-gray-300');
                    strengthBar.style.width = '0%';
                    strengthText.textContent = '-';
                    strengthText.className = 'text-xs text-gray-500';
                }
            }

            // Animation des icônes au focus
            const inputs = document.querySelectorAll('input[type="password"]');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    const icon = this.parentElement.querySelector('svg');
                    if (this.id === 'new-password') {
                        icon.classList.add('text-[#FF8A00]');
                    } else {
                        icon.classList.add('text-gray-600');
                    }
                });

                input.addEventListener('blur', function() {
                    const icon = this.parentElement.querySelector('svg');
                    if (!this.value) {
                        icon.classList.remove('text-[#FF8A00]', 'text-gray-600');
                    }
                });
            });

            // Validation côté client
            const form = document.querySelector('form');
            form.addEventListener('submit', function(e) {
                const oldPassword = document.getElementById('old-password').value;
                const newPassword = document.getElementById('new-password').value;

                if (!oldPassword.trim()) {
                    e.preventDefault();
                    document.getElementById('old-password').classList.add('border-red-500');
                    document.getElementById('old-password').focus();
                    return;
                }

                if (!newPassword.trim() || newPassword.length < 8) {
                    e.preventDefault();
                    document.getElementById('new-password').classList.add('border-red-500');
                    document.getElementById('new-password').focus();
                    return;
                }

                if (oldPassword === newPassword) {
                    e.preventDefault();
                    alert('Le nouveau mot de passe doit être différent de l\'ancien.');
                    document.getElementById('new-password').focus();
                    return;
                }
            });
        });
    </script>
{% endblock %}